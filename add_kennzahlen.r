#Script to add Kennzahlen (Studierende, Personal, Professoren, Grundmittel) to
#db_hex.rds and to prepare faechergruppen-data

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# load packages ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

library(tidyverse)
setwd("C:/Users/Hueck/OneDrive/Dokumente/GitHub/hex-website/")

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# define functions ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

splitter <- function(to_be_splitted_object, split_by = "\\|"){
  splitted_object <- as.vector(unlist(strsplit(to_be_splitted_object,split_by)))
  return(splitted_object)
}

paster <- function(to_be_pasted_object, collapse_by = "|"){
  pasted_object <- paste(to_be_pasted_object, collapse = collapse_by)
  return(pasted_object)
}

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# load data ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

 #Read in db_hex.rds from local working directory
db_hex <- readRDS("data/db_hex.rds") |> mutate(jahr_num=as.numeric(jahr)) |> 
filter(jahr_num > 2016) |> select(-jahr_num)

db_stud <- readRDS("data/db_studi.rds")
db_finanz <- readRDS("data/db_finanz.rds")
db_personal <- readRDS("data/db_personal.rds")

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# check data ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

setdiff(unique(db_hex$hochschule), unique(db_stud$hochschule))
setdiff(unique(db_hex$hochschule), unique(db_finanz$hochschule))
setdiff(unique(db_hex$hochschule), unique(db_personal$hochschule))

#check for same faechergruppe name
db_hex_fg_names <- unique(splitter(db_hex$faechergruppe))
setdiff(db_hex_fg_names, unique(db_stud$faechergruppe))
setdiff(db_hex_fg_names, unique(db_finanz$faechergruppe)) # missing "AuÃŸerhalb der Studienbereichsgliederung"
setdiff(db_hex_fg_names, unique(db_personal$faechergruppe))

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# Count organisations ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

db_count_orgas <- db_hex |> 
  group_by(hochschule) |>
  summarise(n_orga = n_distinct(organisation))

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# generate db_hex_sum ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

#/////////////////////////////////////////////////////////////////////////////
# COMMENT: db_hex_sum contains organisation, hochschule, anzahl_kurse,
# faechergruppe, and sem_jahr
#/////////////////////////////////////////////////////////////////////////////

db_hex_sum <- db_hex |>
  mutate(sem_jahr = paste(semester, jahr, sep="_")) |>
  filter(!organisation=="") |>
  group_by(organisation, hochschule) |>
  reframe(
    anzahl_kurse = n(),
    faechergruppe = list(unique(faechergruppe)),
    hochschule = list(unique(hochschule)),
    sem_jahr = list(unique(sem_jahr))
  ) |>
  distinct() |>
  mutate(sem_jahr = map(sem_jahr, ~ map_chr(.x, function(x) {
    case_when(
      str_detect(x, regex("w|winter|Winter", ignore_case = TRUE)) ~ paste("Winter", str_extract(x, "\\d{4}"), sep="_"),
      str_detect(x, regex("s|sommer|Sommer", ignore_case = TRUE)) ~ paste("Sommer", str_extract(x, "\\d{4}"), sep="_"),
      TRUE ~ x  # To be on the safe side, if no pattern fits: use the original value
    )
  })))

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# generate db_hex_sum_nach_fg -----------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

#/////////////////////////////////////////////////////////////////////////////
# COMMENT: 
#/////////////////////////////////////////////////////////////////////////////

# Maximum number of subject groups per row:
str_count(db_hex$faechergruppe, "\\|") |> na.omit() |> max() + 1

db_hex_sum_raw <- db_hex |>
  filter(!faechergruppe=="") |>
  group_by(faechergruppe, hochschule) |>
  summarise(
    anzahl_kurse = n(),
    .groups = 'drop'
  )|>
  mutate(faechergruppe_n = str_count(faechergruppe, pattern="\\|") + 1) |> # Number of faechergruppe
  mutate(faechergruppe_split = str_split(faechergruppe, pattern="\\|")) |> # faechergruppe-elements as a string-list
  mutate(anzahl_kurse_interdisp = # number of faechergruppe if row is interdisciplinary
  case_when(faechergruppe_n>1 ~ anzahl_kurse,
  TRUE ~ NA_integer_))
 
db_hex_interdisp <- db_hex_sum_raw |> filter(!is.na(anzahl_kurse_interdisp)) |>
  unnest(faechergruppe_split) |> 
  select(hochschule, 
        faechergruppe_split, 
        anzahl_kurse_interdisp,
        faechergruppe_n) |> 
  rename(faechergruppe=faechergruppe_split,
         num_adding_curses=anzahl_kurse_interdisp)
 
db_hex_sum_raw <-  db_hex_sum_raw |> filter(is.na(anzahl_kurse_interdisp)) |> 
                   select(-anzahl_kurse_interdisp, -faechergruppe_n)


db_hex_sum_nach_fg <- left_join(db_hex_sum_raw,db_hex_interdisp, 
                      by=c("hochschule", "faechergruppe")) |>
                      mutate(anzahl_kurse = ifelse(!is.na(num_adding_curses), anzahl_kurse + num_adding_curses, anzahl_kurse))

                      
view(db_hex_sum_nach_fg)
 
# check number of faechergruppe per hochschule
db_count_fgs <- db_hex_sum_nach_fg |> 
  group_by(hochschule) |>
  summarise(n_fgs = n_distinct(faechergruppe))