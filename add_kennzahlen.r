#Script to add Kennzahlen (Studierende, Personal, Professoren, Grundmittel) to
#db_hex.rds and to prepare faechergruppen-data

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# load packages ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

library(tidyverse)
setwd("C:/Users/Hueck/OneDrive/Dokumente/GitHub/hex-website/")

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# define functions ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

splitter <- function(to_be_splitted_object, split_by = "\\|"){
  splitted_object <- as.vector(unlist(strsplit(to_be_splitted_object,split_by)))
  return(splitted_object)
}

paster <- function(to_be_pasted_object, collapse_by = "|"){
  pasted_object <- paste(to_be_pasted_object, collapse = collapse_by)
  return(pasted_object)
}

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# load data ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

 #Read in db_hex.rds from local working directory
db_hex <- readRDS("data/db_hex.rds") |> mutate(jahr_num=as.numeric(jahr)) |> filter(jahr_num > 2016) |> select(-jahr_num)


db_stud <- readRDS("data/db_studi.rds")
db_finanz <- readRDS("data/db_finanz.rds")
db_personal <- readRDS("data/db_personal.rds")

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# check data ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

setdiff(unique(db_hex$hochschule), unique(db_stud$hochschule))
setdiff(unique(db_hex$hochschule), unique(db_finanz$hochschule))
setdiff(unique(db_hex$hochschule), unique(db_personal$hochschule))

#check for same faechergruppe name
db_hex_fg_names <- unique(splitter(db_hex$faechergruppe))
setdiff(db_hex_fg_names, unique(db_stud$faechergruppe))
setdiff(db_hex_fg_names, unique(db_finanz$faechergruppe)) # es fehlt "Außerhalb der Studienbereichsgliederung"
setdiff(db_hex_fg_names, unique(db_personal$faechergruppe))

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# Count Orgas ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

db_count_orgas <- db_hex %>% 
  group_by(hochschule) %>%
  summarise(n_orga = n_distinct(organisation))

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# generate subdata-set ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

db_hex_sum <- db_hex |>
  filter(!hochschule == "Christian-Albrechts-Universität zu Kiel") |>
  mutate(sem_jahr = paste(semester, jahr, sep="_")) |>
  group_by(organisation, hochschule) |>
  reframe(
    anzahl_kurse = n(),
    faechergruppe = list(unique(faechergruppe)),
    hochschule = list(unique(hochschule)),
    sem_jahr = list(unique(sem_jahr))
  ) |>
  distinct()

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
## clean semester-var ------------------------------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////


db_hex_sum <- db_hex_sum |>
  mutate(sem_jahr = map(sem_jahr, ~ map_chr(.x, function(x) {
    case_when(
      str_detect(x, regex("w|winter|Winter", ignore_case = TRUE)) ~ paste("Winter", str_extract(x, "\\d{4}"), sep="_"),
      str_detect(x, regex("s|sommer|Sommer", ignore_case = TRUE)) ~ paste("Sommer", str_extract(x, "\\d{4}"), sep="_"),
      TRUE ~ x  # Sicherheitshalber, falls kein Muster passt
    )
  })))

#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
# generate subdata_set: number courses per hs --------------------------------
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////
#/////////////////////////////////////////////////////////////////////////////

# maximale anzahl von faechergruppe pro Zeile:
str_count(db_hex$faechergruppe, "\\|") |> na.omit() |> max() + 1

db_hex_sum_nach_fg <- db_hex %>%
  filter(hochschule != "Christian-Albrechts-Universität zu Kiel") %>%
  group_by(faechergruppe, hochschule) %>%
  summarise(
    anzahl_kurse = n(),
    .groups = 'drop'
  )|>
  mutate(faechergruppe_n = str_count(faechergruppe, pattern="\\|") + 1) |> # Anzahl fachgruppe
  mutate(faechergruppe_split = str_split(faechergruppe, pattern="\\|")) |> # einzele faechergruppen als Liste
  mutate(anzahl_kurse_interdisp =
  case_when(faechergruppe_n>1 ~ anzahl_kurse,
  TRUE ~ NA_integer_))
 


 